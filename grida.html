import React, { useState, useEffect, useRef } from 'react';
import { Camera, Upload, Play, Pause, Square, Target, BarChart3, Home, Settings, LogOut, Plus, Trash2 } from 'lucide-react';

const GRIDA = () => {
  const [currentScreen, setCurrentScreen] = useState('home');
  const [user, setUser] = useState(null);
  const [timeLeft, setTimeLeft] = useState(1500);
  const [customTime, setCustomTime] = useState(25);
  const [isRunning, setIsRunning] = useState(false);
  const [selectedBgm, setSelectedBgm] = useState('none');
  const [currentSession, setCurrentSession] = useState(null);
  const [artwork, setArtwork] = useState(null);
  const [emotion, setEmotion] = useState('');
  const [focus, setFocus] = useState(3);
  const [memo, setMemo] = useState('');
  const [showOnboarding, setShowOnboarding] = useState(true);
  const [onboardingStep, setOnboardingStep] = useState(0);
  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
  const [goalTrackers, setGoalTrackers] = useState([]);
  const [activeTracker, setActiveTracker] = useState(null);
  const [showCreateTracker, setShowCreateTracker] = useState(false);
  const [badges, setBadges] = useState([]);
  
  const fileInputRef = useRef(null);
  const cameraInputRef = useRef(null);

  const APP_VERSION = "1.0.0";

  const motivationMessages = [
    "ì˜¤ëŠ˜ì˜ í•œ íšì´ ë‚´ì¼ì˜ ì‘í’ˆì„ ë§Œë“­ë‹ˆë‹¤.",
    "ë§¤ì¼ ê·¸ë¦¬ëŠ” ë‹¹ì‹ ì´ ë©‹ì ¸ìš”!",
    "í•œ ì¥ì˜ ê·¸ë¦¼ìœ¼ë¡œ í•˜ë£¨ë¥¼ ì±„ìš°ì„¸ìš”.",
    "ê¾¸ì¤€í•¨ì´ ê³§ ì‹¤ë ¥ì…ë‹ˆë‹¤.",
    "ì˜¤ëŠ˜ë„ ëê¹Œì§€ ì§‘ì¤‘í•´ ë³´ì„¸ìš”.",
    "ì‘ì€ ìŠ¤ì¼€ì¹˜ê°€ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤.",
    "í•˜ë£¨ì˜ ì‹œì‘ì€ ë“œë¡œì‰ìœ¼ë¡œ!",
    "ê·¸ë ¤ë³´ë©´ ì‹¤ë ¥ì´ ì‘¥ ëŠ˜ê²Œ ë ê±°ì˜ˆìš”!",
    "ì‹¤ìˆ˜ë„ ì‘í’ˆì˜ ì¼ë¶€ì…ë‹ˆë‹¤!",
    "íœì„ ë“  ìˆœê°„ì´ ì´ë¯¸ ì„±ê³µì…ë‹ˆë‹¤.",
    "ë§¤ì¼ì˜ ìŠµê´€ì´ ë‚˜ë¥¼ í‚¤ì›ë‹ˆë‹¤.",
    "ê·¸ë¦¼ì€ ë§ˆìŒì„ ë¹„ì¶”ëŠ” ê±°ìš¸ì…ë‹ˆë‹¤.",
    "ë‹¹ì‹ ì˜ ìƒ‰ì„ ë¯¿ìœ¼ì„¸ìš”.",
    "ê¾¸ì¤€í•œ ì—°ìŠµì´ ìµœê³ ì˜ ì„ ìƒë‹˜ì…ë‹ˆë‹¤.",
    "5ë¶„ì´ë¼ë„ ê·¸ë¦¬ë©´, ë‹¹ì‹ ì€ ì´ë¯¸ ì•„í‹°ìŠ¤íŠ¸.",
    "ë°˜ë³µì´ ì²œì¬ë¥¼ ì´ê¹ë‹ˆë‹¤.",
    "ê·¸ë¦¼ì€ ê¾¸ì¤€í•¨ì˜ ê²°ê³¼ë¬¼ì…ë‹ˆë‹¤.",
    "ê·¸ë¦¼ì€ ë‹¹ì‹ ì˜ ëª©ì†Œë¦¬ì…ë‹ˆë‹¤.",
    "ë“œë¡œì‰ì€ ë§ˆìŒì˜ ìš´ë™ì…ë‹ˆë‹¤.",
    "ì‘ì€ ë‹¨ê³„ê°€ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤.",
    "ë§¤ì¼ ê·¸ë¦¼ ê·¸ë¦¬ê¸°ëŠ” ë‚˜ë¥¼ ìœ„í•œ ì•½ì†.",
    "ë§¤ì¼ì˜ ìŠµê´€ì´ ë‚˜ë¥¼ ë¹›ë‚˜ê²Œ í•©ë‹ˆë‹¤.",
    "ê·¸ë¦¼ì€ í•˜ë£¨ë¥¼ íŠ¹ë³„í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.",
    "ê¾¸ì¤€í•¨ì´ ë‹¹ì‹ ì„ í”„ë¡œë¡œ ë§Œë“­ë‹ˆë‹¤.",
    "ê·¸ë¦¼ì€ ì—°ìŠµì—ì„œ ì‹œì‘ë©ë‹ˆë‹¤.",
    "ë¶“ì„ ë“  ìˆœê°„, ì´ë¯¸ ì˜ˆìˆ ê°€.",
    "ë§¤ì¼ ê·¸ë¦¼ ê·¸ë¦¬ê¸°ëŠ” ë‚˜ë¥¼ ëŒë³´ëŠ” ì‹œê°„.",
    "ê¾¸ì¤€íˆ ê·¸ë¦¬ëŠ” ë‹¹ì‹ ì—ê²Œ ë°•ìˆ˜ë¥¼!",
    "ë°˜ë³µì€ ì˜ˆìˆ ì˜ ì–´ë¨¸ë‹ˆ.",
    "ê·¸ë¦¼ìœ¼ë¡œ ë‚˜ë¥¼ í‘œí˜„í•´ë´ìš”.",
    "ë§¤ì¼ ì—°ìŠµ, ë§¤ì¼ ë°œì „.",
    "ê·¸ë¦¼ì€ ê¾¸ì¤€í•¨ì˜ ì—´ë§¤ì…ë‹ˆë‹¤.",
    "ë§¤ì¼ì˜ ë“œë¡œì‰ì´ ë‚˜ë¥¼ ë§Œë“­ë‹ˆë‹¤.",
    "ê·¸ë¦¼ì€ ë‚˜ë¥¼ ìœ„ë¡œí•˜ëŠ” ì–¸ì–´.",
    "ê¾¸ì¤€íˆ ê·¸ë¦¬ëŠ” ë‹¹ì‹ , ìµœê³ ì…ë‹ˆë‹¤.",
    "ì˜¤ëŠ˜ ê·¸ë¦° ê·¸ë¦¼ì´ ë‚´ì¼ì˜ í¬ë§ì´ ë©ë‹ˆë‹¤."
  ];

  const bgmOptions = [
    { id: 'none', name: 'ì—†ìŒ', icon: 'ğŸ”‡' },
    { id: 'forest', name: 'ìˆ²ì†Œë¦¬', icon: 'ğŸŒ²' },
    { id: 'rain', name: 'ë¹—ì†Œë¦¬', icon: 'ğŸŒ§ï¸' },
    { id: 'cafe', name: 'ì¹´í˜', icon: 'â˜•' },
    { id: 'piano', name: 'í”¼ì•„ë…¸', icon: 'ğŸ¹' }
  ];

  const emotionOptions = [
    { id: 'excited', emoji: 'ğŸ¤©', label: 'ì‹ ë‚˜ìš”' },
    { id: 'happy', emoji: 'ğŸ˜Š', label: 'ì¢‹ì•„ìš”' },
    { id: 'neutral', emoji: 'ğŸ˜', label: 'ë³´í†µ' },
    { id: 'tired', emoji: 'ğŸ˜´', label: 'í”¼ê³¤í•´ìš”' },
    { id: 'frustrated', emoji: 'ğŸ˜¤', label: 'ë‹µë‹µí•´ìš”' }
  ];

  const badgeDefinitions = [
    { id: 'first_draw', name: 'ì²« ë“œë¡œì‰', icon: 'ğŸ¨', description: 'ì²« ë“œë¡œì‰ ì™„ë£Œ' },
    { id: 'focus_master', name: 'ì§‘ì¤‘ë ¥ ë§ˆìŠ¤í„°', icon: 'ğŸ§ ', description: 'ì§‘ì¤‘ë„ 5ì  ë‹¬ì„±' },
    { id: 'speed_demon', name: 'ìŠ¤í”¼ë“œ ë“œë¡œì‰', icon: 'âš¡', description: '5ë¶„ ì´ë‚´ ë“œë¡œì‰' },
    { id: 'goal_10', name: 'ëª©í‘œ ë‹¬ì„±ì', icon: 'ğŸ†', description: '10íšŒ ëª©í‘œ ë‹¬ì„±' },
    { id: 'goal_30', name: 'ì›”ê°„ ì±Œë¦°ì €', icon: 'ğŸ¥‡', description: '30íšŒ ëª©í‘œ ë‹¬ì„±' },
    { id: 'emotion_happy', name: 'í•´í”¼ ë“œë¡œì‰', icon: 'ğŸ˜Š', description: 'ì¦ê±°ìš´ ê°ì •ìœ¼ë¡œ ë“œë¡œì‰' },
    { id: 'long_session', name: 'ì¸ë‚´ì˜ í™”ê°€', icon: 'ğŸ­', description: '60ë¶„ ì´ìƒ ë“œë¡œì‰' }
  ];

  const getTodayMotivation = () => {
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    return motivationMessages[dayOfYear % motivationMessages.length];
  };

  useEffect(() => {
    const savedData = localStorage.getItem('gridaData');
    if (savedData) {
      try {
        const data = JSON.parse(savedData);
        setUser(data.user || null);
        setGoalTrackers(data.goalTrackers || []);
        setActiveTracker(data.activeTracker || null);
        setBadges(data.badges || []);
        setShowOnboarding(!data.user);
      } catch (e) {
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', e);
      }
    }
  }, []);

  useEffect(() => {
    if (isRunning && timeLeft > 0) {
      const interval = setInterval(() => {
        setTimeLeft(prev => {
          if (prev <= 1) {
            setIsRunning(false);
            handleTimerComplete();
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
      return () => clearInterval(interval);
    }
  }, [isRunning, timeLeft]);

  const handleTimerComplete = () => {
    if (Notification.permission === 'granted') {
      new Notification('ë“œë¡œì‰ íƒ€ì´ë¨¸ ì™„ë£Œ!', {
        body: 'ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ì‘í’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”.',
        icon: 'ğŸ¨'
      });
    }
    
    const session = {
      date: new Date().toISOString().split('T')[0],
      duration: customTime - Math.floor(timeLeft / 60),
      startTime: new Date().toISOString(),
      bgm: selectedBgm
    };
    setCurrentSession(session);
    setCurrentScreen('artwork');
  };

  const toggleTimer = () => {
    if (!isRunning && Notification.permission === 'default') {
      Notification.requestPermission();
    }
    setIsRunning(!isRunning);
  };

  const resetTimer = () => {
    setIsRunning(false);
    setTimeLeft(customTime * 60);
  };

  const applyCustomTime = () => {
    if (!isRunning) {
      setTimeLeft(customTime * 60);
    }
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  const handleImageUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          const maxSize = 800;
          let { width, height } = img;
          
          if (width > height) {
            if (width > maxSize) {
              height = (height * maxSize) / width;
              width = maxSize;
            }
          } else {
            if (height > maxSize) {
              width = (width * maxSize) / height;
              height = maxSize;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          
          const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
          setArtwork(resizedDataUrl);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  };

  const saveSession = () => {
    if (!currentSession) return;
    
    const sessionData = {
      ...currentSession,
      emotion,
      focus,
      memo,
      artwork
    };
    
    const existingData = JSON.parse(localStorage.getItem('gridaData') || '{}');
    if (!existingData.sessions) existingData.sessions = {};
    
    existingData.sessions[currentSession.date] = sessionData;
    
    // í™œì„± íŠ¸ë˜ì»¤ ì—…ë°ì´íŠ¸
    if (activeTracker) {
      const updatedTrackers = goalTrackers.map(tracker => 
        tracker.id === activeTracker.id 
          ? { ...tracker, completed: Math.min(tracker.completed + 1, tracker.target) }
          : tracker
      );
      setGoalTrackers(updatedTrackers);
      existingData.goalTrackers = updatedTrackers;
    }
    
    // ë±ƒì§€ ì²´í¬
    const newBadges = checkBadges(sessionData, existingData);
    setBadges(newBadges);
    existingData.badges = newBadges;
    
    localStorage.setItem('gridaData', JSON.stringify(existingData));
    
    setCurrentSession(null);
    setArtwork(null);
    setEmotion('');
    setFocus(3);
    setMemo('');
    resetTimer();
    setCurrentScreen('home');
  };

  const checkBadges = (sessionData, existingData) => {
    const currentBadges = existingData.badges || [];
    const newBadges = [...currentBadges];
    const sessions = existingData.sessions || {};
    
    // ì²« ë“œë¡œì‰ ë±ƒì§€
    if (!newBadges.some(b => b.id === 'first_draw') && Object.keys(sessions).length >= 1) {
      newBadges.push({ id: 'first_draw', earnedAt: new Date().toISOString() });
    }
    
    // ì§‘ì¤‘ë ¥ ë§ˆìŠ¤í„° ë±ƒì§€
    if (!newBadges.some(b => b.id === 'focus_master') && sessionData.focus === 5) {
      newBadges.push({ id: 'focus_master', earnedAt: new Date().toISOString() });
    }
    
    // ìŠ¤í”¼ë“œ ë“œë¡œì‰ ë±ƒì§€
    if (!newBadges.some(b => b.id === 'speed_demon') && sessionData.duration <= 5) {
      newBadges.push({ id: 'speed_demon', earnedAt: new Date().toISOString() });
    }
    
    // ì¥ì‹œê°„ ë“œë¡œì‰ ë±ƒì§€
    if (!newBadges.some(b => b.id === 'long_session') && sessionData.duration >= 60) {
      newBadges.push({ id: 'long_session', earnedAt: new Date().toISOString() });
    }
    
    // í•´í”¼ ë“œë¡œì‰ ë±ƒì§€
    if (!newBadges.some(b => b.id === 'emotion_happy') && sessionData.emotion === 'happy') {
      newBadges.push({ id: 'emotion_happy', earnedAt: new Date().toISOString() });
    }
    
    // ëª©í‘œ ë‹¬ì„± ë±ƒì§€ë“¤
    const totalSessions = Object.keys(sessions).length;
    if (!newBadges.some(b => b.id === 'goal_10') && totalSessions >= 10) {
      newBadges.push({ id: 'goal_10', earnedAt: new Date().toISOString() });
    }
    if (!newBadges.some(b => b.id === 'goal_30') && totalSessions >= 30) {
      newBadges.push({ id: 'goal_30', earnedAt: new Date().toISOString() });
    }
    
    return newBadges;
  };

  const createGoalTracker = (name, target, description) => {
    const newTracker = {
      id: Date.now().toString(),
      name,
      target,
      description,
      completed: 0,
      createdAt: new Date().toISOString()
    };
    
    const updatedTrackers = [...goalTrackers, newTracker];
    setGoalTrackers(updatedTrackers);
    
    if (goalTrackers.length === 0) {
      setActiveTracker(newTracker);
    }
    
    const existingData = JSON.parse(localStorage.getItem('gridaData') || '{}');
    existingData.goalTrackers = updatedTrackers;
    if (goalTrackers.length === 0) {
      existingData.activeTracker = newTracker;
    }
    localStorage.setItem('gridaData', JSON.stringify(existingData));
    
    setShowCreateTracker(false);
  };

  const deleteTracker = (trackerId) => {
    const updatedTrackers = goalTrackers.filter(t => t.id !== trackerId);
    setGoalTrackers(updatedTrackers);
    
    if (activeTracker?.id === trackerId) {
      setActiveTracker(updatedTrackers[0] || null);
    }
    
    const existingData = JSON.parse(localStorage.getItem('gridaData') || '{}');
    existingData.goalTrackers = updatedTrackers;
    existingData.activeTracker = activeTracker?.id === trackerId ? (updatedTrackers[0] || null) : activeTracker;
    localStorage.setItem('gridaData', JSON.stringify(existingData));
  };

  const completeOnboarding = (userData) => {
    setUser(userData);
    setShowOnboarding(false);
    
    const data = {
      user: userData,
      goalTrackers: [],
      activeTracker: null,
      badges: [],
      settings: {}
    };
    localStorage.setItem('gridaData', JSON.stringify(data));
    setCurrentScreen('home');
  };

  const handleLogout = () => {
    localStorage.removeItem('gridaData');
    setUser(null);
    setShowOnboarding(true);
    setOnboardingStep(0);
    setCurrentScreen('home');
    setShowLogoutConfirm(false);
    setTimeLeft(1500);
    setCustomTime(25);
    setIsRunning(false);
    setSelectedBgm('none');
    setCurrentSession(null);
    setArtwork(null);
    setEmotion('');
    setFocus(3);
    setMemo('');
    setGoalTrackers([]);
    setActiveTracker(null);
    setBadges([]);
  };

  const getCalendarData = () => {
    const data = JSON.parse(localStorage.getItem('gridaData') || '{}');
    return data.sessions || {};
  };

  const getReportData = () => {
    const sessions = getCalendarData();
    const thisWeek = Object.values(sessions).filter(session => {
      const sessionDate = new Date(session.date);
      const today = new Date();
      const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
      return sessionDate >= weekStart;
    });
    
    return {
      totalTime: thisWeek.reduce((acc, session) => acc + (session.duration || 0), 0),
      avgFocus: thisWeek.length > 0 ? thisWeek.reduce((acc, session) => acc + (session.focus || 3), 0) / thisWeek.length : 0,
      completedDays: thisWeek.length,
      emotions: thisWeek.reduce((acc, session) => {
        if (session.emotion) {
          acc[session.emotion] = (acc[session.emotion] || 0) + 1;
        }
        return acc;
      }, {})
    };
  };

  if (showOnboarding) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-4">
        <div className="max-w-md mx-auto">
          {onboardingStep === 0 && (
            <div className="text-center py-20">
              <div className="text-6xl mb-6">ğŸ¨</div>
              <h1 className="text-3xl font-bold text-gray-800 mb-4">GRIDA</h1>
              <p className="text-gray-600 mb-8">ë§¤ì¼ ê·¸ë¦¼ì„ ê·¸ë¦¬ëŠ” ìŠµê´€ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
              <button
                onClick={() => setOnboardingStep(1)}
                className="bg-purple-500 text-white px-8 py-3 rounded-full font-medium hover:bg-purple-600 transition-colors"
              >
                ì‹œì‘í•˜ê¸°
              </button>
            </div>
          )}
          
          {onboardingStep === 1 && (
            <div className="py-10">
              <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">í”„ë¡œí•„ ì„¤ì •</h2>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ë‹‰ë„¤ì„
                  </label>
                  <input
                    type="text"
                    placeholder="ë“œë¡œì‰ ëŸ¬ë²„"
                    id="nickname-input"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    onKeyPress={(e) => {
                      if (e.key === 'Enter') {
                        const nickname = e.target.value.trim() || 'ë“œë¡œì‰ ëŸ¬ë²„';
                        completeOnboarding({ nickname });
                      }
                    }}
                  />
                </div>
                
                <button
                  onClick={() => {
                    const nicknameInput = document.getElementById('nickname-input');
                    const nickname = nicknameInput?.value.trim() || 'ë“œë¡œì‰ ëŸ¬ë²„';
                    completeOnboarding({ nickname });
                  }}
                  className="w-full bg-purple-500 text-white py-3 rounded-lg font-medium hover:bg-purple-600 transition-colors"
                >
                  ì‹œì‘í•˜ê¸°
                </button>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 pb-20">
      <header className="bg-white shadow-sm p-4">
        <div className="max-w-md mx-auto flex items-center justify-between">
          <h1 className="text-xl font-bold text-gray-800">GRIDA</h1>
          <div className="flex items-center space-x-3">
            <span className="text-sm text-gray-600">ì•ˆë…•í•˜ì„¸ìš”, {user?.nickname}ë‹˜!</span>
            <button
              onClick={() => setCurrentScreen('settings')}
              className="p-2 text-gray-500 hover:text-gray-700 transition-colors"
            >
              <Settings size={20} />
            </button>
          </div>
        </div>
      </header>

      <div className="max-w-md mx-auto p-4">
        {currentScreen === 'home' && (
          <div className="space-y-6">
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <div className="text-center">
                <div className="text-4xl mb-2">ğŸ¨</div>
                <h2 className="text-lg font-semibold text-gray-800">
                  {getTodayMotivation()}
                </h2>
                <p className="text-sm text-gray-600 mt-1">
                  {new Date().toLocaleDateString('ko-KR', { 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long' 
                  })}
                </p>
              </div>
            </div>

            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <div className="text-center">
                <div className="mb-6">
                  <label className="block text-sm font-medium text-gray-700 mb-3">
                    ë“œë¡œì‰ ì‹œê°„ ì„¤ì •
                  </label>
                  <input
                    type="range"
                    min="5"
                    max="120"
                    value={customTime}
                    onChange={(e) => setCustomTime(Number(e.target.value))}
                    onMouseUp={applyCustomTime}
                    onTouchEnd={applyCustomTime}
                    disabled={isRunning}
                    className="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50"
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-2">
                    <span>5ë¶„</span>
                    <span className="font-semibold text-purple-600">{customTime}ë¶„</span>
                    <span>2ì‹œê°„</span>
                  </div>
                  {isRunning && (
                    <p className="text-xs text-orange-600 mt-1">
                      * íƒ€ì´ë¨¸ ì‹¤í–‰ ì¤‘ì—ëŠ” ì‹œê°„ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤
                    </p>
                  )}
                </div>

                <div className="text-4xl font-bold text-purple-600 mb-4">
                  {formatTime(timeLeft)}
                </div>
                <div className="flex justify-center space-x-4 mb-4">
                  <button
                    onClick={toggleTimer}
                    className={`flex items-center space-x-2 px-6 py-3 rounded-full font-medium transition-colors ${
                      isRunning
                        ? 'bg-red-500 text-white hover:bg-red-600'
                        : 'bg-purple-500 text-white hover:bg-purple-600'
                    }`}
                  >
                    {isRunning ? <Pause size={20} /> : <Play size={20} />}
                    <span>{isRunning ? 'ì¼ì‹œì •ì§€' : 'ì‹œì‘'}</span>
                  </button>
                  <button
                    onClick={resetTimer}
                    className="flex items-center space-x-2 px-6 py-3 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors"
                  >
                    <Square size={20} />
                    <span>ë¦¬ì…‹</span>
                  </button>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h3 className="text-lg font-semibold text-gray-800 mb-4">ë°°ê²½ìŒì•…</h3>
              <div className="grid grid-cols-3 gap-2">
                {bgmOptions.map((bgm) => (
                  <button
                    key={bgm.id}
                    onClick={() => setSelectedBgm(bgm.id)}
                    className={`p-3 rounded-lg text-sm font-medium transition-colors ${
                      selectedBgm === bgm.id
                        ? 'bg-purple-500 text-white'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    <div className="text-lg mb-1">{bgm.icon}</div>
                    <div>{bgm.name}</div>
                  </button>
                ))}
              </div>
            </div>

            {activeTracker && (
              <div className="bg-white rounded-2xl p-6 shadow-sm">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className="text-lg font-semibold text-gray-800">{activeTracker.name}</h3>
                    <p className="text-sm text-gray-600">{activeTracker.description}</p>
                  </div>
                  <div className="text-right">
                    <div className="text-2xl font-bold text-purple-600">
                      {activeTracker.completed}/{activeTracker.target}
                    </div>
                    <div className="text-xs text-gray-500">
                      {Math.round((activeTracker.completed / activeTracker.target) * 100)}%
                    </div>
                  </div>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-purple-500 h-2 rounded-full transition-all duration-300"
                    style={{ width: `${Math.min((activeTracker.completed / activeTracker.target) * 100, 100)}%` }}
                  ></div>
                </div>
              </div>
            )}

            {badges.length > 0 && (
              <div className="bg-white rounded-2xl p-6 shadow-sm">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">ìµœê·¼ íšë“ ë±ƒì§€</h3>
                <div className="flex space-x-3 overflow-x-auto">
                  {badges.slice(-4).map((badge) => {
                    const badgeInfo = badgeDefinitions.find(b => b.id === badge.id);
                    return (
                      <div key={badge.id} className="flex-shrink-0 text-center">
                        <div className="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mb-2">
                          <span className="text-xl">{badgeInfo?.icon}</span>
                        </div>
                        <div className="text-xs text-gray-600 w-16">{badgeInfo?.name}</div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        )}

        {currentScreen === 'artwork' && (
          <div className="space-y-6">
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h2 className="text-xl font-bold text-gray-800 mb-4 text-center">ì‘í’ˆ ë“±ë¡</h2>
              
              {!artwork ? (
                <div className="space-y-4">
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                    <div className="text-4xl mb-4">ğŸ“¸</div>
                    <p className="text-gray-600 mb-4">ì˜¤ëŠ˜ ê·¸ë¦° ì‘í’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
                    <div className="space-y-3">
                      <button
                        onClick={() => cameraInputRef.current?.click()}
                        className="w-full flex items-center justify-center space-x-2 bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition-colors"
                      >
                        <Camera size={20} />
                        <span>ì‚¬ì§„ ì´¬ì˜</span>
                      </button>
                      <button
                        onClick={() => fileInputRef.current?.click()}
                        className="w-full flex items-center justify-center space-x-2 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors"
                      >
                        <Upload size={20} />
                        <span>ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ</span>
                      </button>
                      <button
                        onClick={() => setCurrentScreen('emotion')}
                        className="w-full text-gray-500 py-2 hover:text-gray-700 transition-colors"
                      >
                        ê±´ë„ˆë›°ê¸°
                      </button>
                    </div>
                  </div>
                  
                  <input
                    ref={cameraInputRef}
                    type="file"
                    accept="image/*"
                    capture="environment"
                    onChange={handleImageUpload}
                    className="hidden"
                  />
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept="image/*"
                    onChange={handleImageUpload}
                    className="hidden"
                  />
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="rounded-lg overflow-hidden">
                    <img 
                      src={artwork} 
                      alt="ë“±ë¡ëœ ì‘í’ˆ" 
                      className="w-full h-64 object-cover"
                    />
                  </div>
                  <div className="flex space-x-3">
                    <button
                      onClick={() => setArtwork(null)}
                      className="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors"
                    >
                      ë‹¤ì‹œ ì„ íƒ
                    </button>
                    <button
                      onClick={() => setCurrentScreen('emotion')}
                      className="flex-1 bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition-colors"
                    >
                      ë‹¤ìŒ
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {currentScreen === 'emotion' && (
          <div className="space-y-6">
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h2 className="text-xl font-bold text-gray-800 mb-6 text-center">
                ì˜¤ëŠ˜ì˜ ë“œë¡œì‰ì€ ì–´ë– ì…¨ë‚˜ìš”?
              </h2>
              
              <div className="mb-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">ê°ì •</h3>
                <div className="grid grid-cols-3 gap-3">
                  {emotionOptions.map((option) => (
                    <button
                      key={option.id}
                      onClick={() => setEmotion(option.id)}
                      className={`p-4 rounded-lg text-center transition-all ${
                        emotion === option.id
                          ? 'bg-purple-500 text-white shadow-lg transform scale-105'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      <div className="text-2xl mb-2">{option.emoji}</div>
                      <div className="text-sm font-medium">{option.label}</div>
                    </button>
                  ))}
                </div>
              </div>

              <div className="mb-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">ì§‘ì¤‘ë„</h3>
                <div className="px-4">
                  <input
                    type="range"
                    min="1"
                    max="5"
                    value={focus}
                    onChange={(e) => setFocus(Number(e.target.value))}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                  <div className="flex justify-between text-sm text-gray-600 mt-2">
                    <span>ë‚®ìŒ</span>
                    <span className="font-semibold text-purple-600">{focus}/5</span>
                    <span>ë†’ìŒ</span>
                  </div>
                </div>
              </div>

              <div className="mb-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">ë©”ëª¨ (ì„ íƒ)</h3>
                <textarea
                  value={memo}
                  onChange={(e) => setMemo(e.target.value)}
                  placeholder="ì˜¤ëŠ˜ì˜ ë“œë¡œì‰ì— ëŒ€í•œ ìƒê°ì„ ê¸°ë¡í•´ë³´ì„¸ìš”..."
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                  rows="4"
                  maxLength="300"
                />
                <div className="text-right text-sm text-gray-500 mt-1">
                  {memo.length}/300
                </div>
              </div>

              <button
                onClick={saveSession}
                disabled={!emotion}
                className={`w-full py-4 rounded-lg font-medium transition-colors ${
                  emotion
                    ? 'bg-purple-500 text-white hover:bg-purple-600'
                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                }`}
              >
                ì €ì¥í•˜ê¸°
              </button>
            </div>
          </div>
        )}

        {currentScreen === 'goals' && (
          <div className="space-y-6">
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-xl font-bold text-gray-800">ëª©í‘œ íŠ¸ë˜ì»¤</h2>
                <button
                  onClick={() => setShowCreateTracker(true)}
                  className="bg-purple-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-600 transition-colors"
                >
                  + ìƒˆ ëª©í‘œ
                </button>
              </div>
              
              {goalTrackers.length === 0 ? (
                <div className="text-center py-8">
                  <div className="text-4xl mb-4">ğŸ¯</div>
                  <p className="text-gray-600 mb-4">ì•„ì§ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                  <button
                    onClick={() => setShowCreateTracker(true)}
                    className="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors"
                  >
                    ì²« ëª©í‘œ ë§Œë“¤ê¸°
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  {goalTrackers.map((tracker) => (
                    <div 
                      key={tracker.id}
                      className={`p-4 rounded-lg border-2 transition-all cursor-pointer ${
                        activeTracker?.id === tracker.id 
                          ? 'border-purple-500 bg-purple-50' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                      onClick={() => {
                        setActiveTracker(tracker);
                        const existingData = JSON.parse(localStorage.getItem('gridaData') || '{}');
                        existingData.activeTracker = tracker;
                        localStorage.setItem('gridaData', JSON.stringify(existingData));
                      }}
                    >
                      <div className="flex items-center justify-between mb-3">
                        <div>
                          <h3 className="font-semibold text-gray-800">{tracker.name}</h3>
                          <p className="text-sm text-gray-600">{tracker.description}</p>
                        </div>
                        <div className="flex items-center space-x-2">
                          <span className="text-sm font-medium text-purple-600">
                            {tracker.completed}/{tracker.target}
                          </span>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              deleteTracker(tracker.id);
                            }}
                            className="text-red-500 hover:text-red-700 p-1"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                      
                      <div className="w-full bg-gray-200 rounded-full h-2 mb-3">
                        <div 
                          className="bg-purple-500 h-2 rounded-full transition-all duration-300"
                          style={{ width: `${Math.min((tracker.completed / tracker.target) * 100, 100)}%` }}
                        ></div>
                      </div>
                      
                      {tracker.completed >= tracker.target && (
                        <div className="text-center">
                          <span className="text-2xl">ğŸ‰</span>
                          <span className="text-sm text-green-600 ml-2">ëª©í‘œ ë‹¬ì„±!</span>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h3 className="text-lg font-semibold text-gray-800 mb-4">ë±ƒì§€ ì»¬ë ‰ì…˜</h3>
              <div className="grid grid-cols-3 gap-4">
                {badgeDefinitions.map((badgeInfo) => {
                  const earned = badges.some(b => b.id === badgeInfo.id);
                  return (
                    <div 
                      key={badgeInfo.id}
                      className={`text-center p-3 rounded-lg transition-all ${
                        earned ? 'bg-yellow-50 border-2 border-yellow-200' : 'bg-gray-50 border-2 border-gray-200'
                      }`}
                    >
                      <div className={`text-2xl mb-2 ${earned ? '' : 'opacity-30'}`}>
                        {badgeInfo.icon}
                      </div>
                      <div className={`text-xs font-medium ${earned ? 'text-yellow-800' : 'text-gray-500'}`}>
                        {badgeInfo.name}
                      </div>
                      <div className={`text-xs mt-1 ${earned ? 'text-yellow-600' : 'text-gray-400'}`}>
                        {badgeInfo.description}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {currentScreen === 'report' && (
          <div className="space-y-6">
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h2 className="text-xl font-bold text-gray-800 mb-6 text-center">ì´ë²ˆ ì£¼ ë¦¬í¬íŠ¸</h2>
              
              {(() => {
                const reportData = getReportData();
                return (
                  <div className="space-y-6">
                    <div className="grid grid-cols-2 gap-4">
                      <div className="text-center p-4 bg-purple-50 rounded-lg">
                        <div className="text-2xl font-bold text-purple-600">
                          {Math.floor(reportData.totalTime / 60)}ì‹œê°„
                        </div>
                        <div className="text-sm text-gray-600">ì´ ë“œë¡œì‰ ì‹œê°„</div>
                      </div>
                      <div className="text-center p-4 bg-pink-50 rounded-lg">
                        <div className="text-2xl font-bold text-pink-600">
                          {reportData.completedDays}ì¼
                        </div>
                        <div className="text-sm text-gray-600">ì™„ë£Œí•œ ë‚ </div>
                      </div>
                    </div>
                    
                    <div className="text-center p-4 bg-yellow-50 rounded-lg">
                      <div className="text-2xl font-bold text-yellow-600">
                        {reportData.avgFocus.toFixed(1)}/5
                      </div>
                      <div className="text-sm text-gray-600">í‰ê·  ì§‘ì¤‘ë„</div>
                    </div>
                    
                    <div className="p-4 bg-gray-50 rounded-lg">
                      <h4 className="text-lg font-semibold text-gray-800 mb-3">ê°ì • ë¶„í¬</h4>
                      <div className="space-y-2">
                        {Object.entries(reportData.emotions).map(([emotionId, count]) => {
                          const emotion = emotionOptions.find(e => e.id === emotionId);
                          if (!emotion) return null;
                          
                          return (
                            <div key={emotionId} className="flex items-center justify-between">
                              <div className="flex items-center space-x-2">
                                <span className="text-lg">{emotion.emoji}</span>
                                <span className="text-sm text-gray-700">{emotion.label}</span>
                              </div>
                              <span className="text-sm font-semibold text-gray-800">{count}íšŒ</span>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                );
              })()}
            </div>
          </div>
        )}

        {currentScreen === 'settings' && (
          <div className="space-y-6">
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h2 className="text-xl font-bold text-gray-800 mb-6 text-center">ì„¤ì •</h2>
              
              <div className="space-y-4">
                <div className="p-4 bg-gray-50 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-800 mb-2">ì‚¬ìš©ì ì •ë³´</h3>
                  <div className="flex items-center space-x-3">
                    <div className="text-3xl">ğŸ¨</div>
                    <div>
                      <p className="font-medium text-gray-800">{user?.nickname}</p>
                      <p className="text-sm text-gray-600">ë“œë¡œì‰ ëŸ¬ë²„</p>
                    </div>
                  </div>
                </div>

                <div className="p-4 bg-gray-50 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-800 mb-3">ì•± ì •ë³´</h3>
                  <div className="space-y-2">
                    <div className="flex justify-between items-center">
                      <span className="text-sm text-gray-600">ë²„ì „</span>
                      <span className="text-sm font-medium text-gray-800">v{APP_VERSION}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-sm text-gray-600">ê°œë°œì</span>
                      <span className="text-sm font-medium text-gray-800">GRIDA Team</span>
                    </div>
                  </div>
                </div>

                <div className="p-4 bg-gray-50 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-800 mb-3">ë‚˜ì˜ ê¸°ë¡</h3>
                  <div className="space-y-2">
                    <div className="flex justify-between items-center">
                      <span className="text-sm text-gray-600">ì™„ë£Œ íšŸìˆ˜</span>
                      <span className="text-sm font-medium text-purple-600">{Object.keys(getCalendarData()).length}íšŒ</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-sm text-gray-600">íšë“ ë±ƒì§€</span>
                      <span className="text-sm font-medium text-purple-600">{badges.length}ê°œ</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-sm text-gray-600">í™œì„± ëª©í‘œ</span>
                      <span className="text-sm font-medium text-purple-600">{goalTrackers.length}ê°œ</span>
                    </div>
                  </div>
                </div>

                <button
                  onClick={() => setShowLogoutConfirm(true)}
                  className="w-full flex items-center justify-center space-x-2 py-3 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                >
                  <LogOut size={20} />
                  <span>ë¡œê·¸ì•„ì›ƒ</span>
                </button>
              </div>
            </div>
          </div>
        )}
      </div>

      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200">
        <div className="max-w-md mx-auto flex">
          {[
            { id: 'home', icon: Home, label: 'í™ˆ' },
            { id: 'goals', icon: Target, label: 'ëª©í‘œ' },
            { id: 'report', icon: BarChart3, label: 'ë¦¬í¬íŠ¸' },
            { id: 'settings', icon: Settings, label: 'ì„¤ì •' }
          ].map((item) => (
            <button
              key={item.id}
              onClick={() => setCurrentScreen(item.id)}
              className={`flex-1 flex flex-col items-center py-3 transition-colors ${
                currentScreen === item.id
                  ? 'text-purple-500'
                  : 'text-gray-400 hover:text-gray-600'
              }`}
            >
              <item.icon size={24} />
              <span className="text-xs mt-1">{item.label}</span>
            </button>
          ))}
        </div>
      </nav>

      {showCreateTracker && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
            <h3 className="text-lg font-bold text-gray-800 mb-4 text-center">ìƒˆ ëª©í‘œ ë§Œë“¤ê¸°</h3>
            <form onSubmit={(e) => {
              e.preventDefault();
              const formData = new FormData(e.target);
              const name = formData.get('name');
              const target = parseInt(formData.get('target'));
              const description = formData.get('description');
              
              if (name && target && description) {
                createGoalTracker(name, target, description);
              }
            }}>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ëª©í‘œ ì´ë¦„
                  </label>
                  <input
                    type="text"
                    name="name"
                    placeholder="ì˜ˆ: ì¸ë¬¼í™” ë§ˆìŠ¤í„°"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    required
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ëª©í‘œ íšŸìˆ˜
                  </label>
                  <input
                    type="number"
                    name="target"
                    min="1"
                    max="100"
                    defaultValue="20"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    required
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ëª©í‘œ ì„¤ëª…
                  </label>
                  <textarea
                    name="description"
                    placeholder="ì˜ˆ: ì¸ë¬¼í™” ê¸°ì´ˆë¥¼ ìµíˆê¸° ìœ„í•œ ì—°ìŠµ"
                    rows="3"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                    required
                  />
                </div>
              </div>
              
              <div className="flex space-x-3 mt-6">
                <button
                  type="button"
                  onClick={() => setShowCreateTracker(false)}
                  className="flex-1 py-3 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  ì·¨ì†Œ
                </button>
                <button
                  type="submit"
                  className="flex-1 py-3 px-4 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors"
                >
                  ìƒì„±
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {showLogoutConfirm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
            <h3 className="text-lg font-bold text-gray-800 mb-4 text-center">ë¡œê·¸ì•„ì›ƒ</h3>
            <p className="text-gray-600 text-center mb-6">
              ì •ë§ë¡œ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br />
              ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.
            </p>
            <div className="flex space-x-3">
              <button
                onClick={() => setShowLogoutConfirm(false)}
                className="flex-1 py-3 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
              >
                ì·¨ì†Œ
              </button>
              <button
                onClick={handleLogout}
                className="flex-1 py-3 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
              >
                ë¡œê·¸ì•„ì›ƒ
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default GRIDA;